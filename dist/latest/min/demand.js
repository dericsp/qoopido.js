/*! Qoopido.js 4.0.0, 2015-09-01 | https://github.com/dlueth/qoopido.js | (c) 2015 Dirk Lueth */
!function(e){"use strict";function t(){var e=this||{},t=s(e,v)?e:null,n=T.call(arguments);return n.forEach(function(e,n){var r=y.path(e,t),a=r.handler,o=r.path,u=z[a]||(z[a]={});this[n]=u[o]||(u[o]=new h(e,t).bond)},n),i.all(n)}function n(){var e,t,n=arguments[0]&&"string"==typeof arguments[0]&&arguments[0]||null,r=!n&&arguments[0]||arguments[1];if(!n&&g.current&&(t=g.current,n=t.handler+"!"+t.path),!n)throw new f("unspecified anonymous provide");return S(function(){var a,o,u,l=y.path(n),c=z[l.handler];if(!t&&c[l.path])throw new f("duplicate found for module",n);a=new v(n,r,e||[]),o=z[a.handler][a.path]=a.bond,t&&(!t.cached&&t.store(),u=t.defered,o.then(function(){u.resolve.apply(null,arguments)},function(){u.reject(new f("unable to resolve module",n,arguments))}),g.length>0&&g.next())}),{when:function(){e=T.call(arguments)}}}function r(e){var t,n=e.version,r=e.base,a=e.pattern;if(n&&(m=n),r&&(B=new p(r,y.url(r).href)),a)for(t in a)G[t]=new p(t,a[t]);return!0}function a(e,t,n){X[e]||(X[e]={suffix:t,resolve:n.resolve,modify:n.modify},z[e]={})}function o(e){var t=s(e,f)?"error":"info";"undefined"!=typeof console&&console[t](e.toString())}function u(e){return e.replace(I,"\\$&")}function l(e){return R.test(e)}function c(e){return e.replace(P,"")}function s(e,t){return e instanceof t}function i(e){function t(){r(J,arguments)}function n(){r(L,arguments)}function r(e,t){a.state===C&&(a.state=e,a.value=t,o[e].forEach(function(e){e.apply(null,a.value)}))}var a=this,o={resolved:[],rejected:[]};a.then=function(e,t){var n=this;if(n.state===C)e&&o[J].push(e),t&&o[L].push(t);else switch(n.state){case J:e.apply(null,n.value);break;case L:t.apply(null,n.value)}},e(t,n)}function f(e,t,n){var r=this;return r.message=e,r.module=t,n&&(r.stack=n),r}function p(e,t){var n=this;n.url=y.url(t).href,n.regexPattern=new RegExp("^"+u(e)),n.regexUrl=new RegExp("^"+u(t))}function d(){var e=this;e.queue=[],e.current=null}function h(e,t){var n,r,a=this,u=i.defer(),l=new XMLHttpRequest;return y.path.call(a,e,t),a.defered=u,a.bond=u.bond,a.cached=!1,n=X[a.handler],parent||a.bond.then(null,o),n?(r=a.retrieve(),r?g.add(a):(l.onreadystatechange=function(){4===l.readyState&&(200===l.status||0===l.status&&l.responseText?(a.source=l.responseText,g.add(a)):u.reject(new f("unable to load module",a.path)))},l.open("GET",a.url+n.suffix,!0),l.send(),S(function(){l.readyState<4&&l.abort()},5e3))):u.reject(new f('no handler "'+a.handler+'" for',a.path)),a}function v(e,n,r){var a=this,u=i.defer();return y.path.call(a,e),a.bond=u.bond,a.bond.then(null,function(e){o(new f("unable to resolve module",a.path,e))}),r.length>0?t.apply(a,r).then(function(){u.resolve(n.apply(null,arguments))},function(e){u.reject(new f("unable to resolve dependencies for",a.path,e))}):u.resolve(n()),a}var m,g,y,w,b,x,j=document,E=localStorage,S=setTimeout,T=Array.prototype.slice,q=Array.prototype.concat,k=j.getElementsByTagName("head")[0],A=j.createElement("a"),R=/^\//i,H=/^([-\w]+\/[-\w]+)!/,I=/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,N=/url\(\s*(?:"|'|)(?!data:|http:|https:|\/)(.+?)(?:"|'|)\)/g,P=/^http(s?):/,C="pending",J="resolved",L="rejected",M={version:"1.0.0",base:"/"},O=e.demand.main,U=e.demand.settings,$=e.location.host,B={},G={},X={},z={};y={url:function(e){return A.href=e,A},path:function(e,t){var n,r,a,o=this,i=e.match(H)||"application/javascript",f=s(o,h);"string"!=typeof i&&(e=e.replace(new RegExp("^"+u(i[0])),""),i=i[1]),e=(n=l(e))?B.remove(y.url(B.url+e).href):y.url((t&&t.path+"/../"||"/")+e).pathname;for(r in G)G[r].matches(e)&&(a=G[r]);return f||s(o,v)?(o.handler=i,o.path=e,f&&(o.url=c(y.url(a?a.process(e):(n?"//"+$:B.url)+e).href)),void 0):{handler:i,path:e}}},w={get:function(e,t){var n=JSON.parse(E.getItem(e));return n&&n.version===m&&n.url===t?n:void 0},set:function(e,t,n){E.setItem(e,JSON.stringify({version:m,url:n,source:t}))},clear:function(e){e&&E.removeItem(e)||E.clear()}},i.prototype={constructor:i,state:C,value:null,listener:null},i.defer=function(){var e={};return e.bond=new i(function(t,n){e.resolve=t,e.reject=n}),e},i.all=function(e){var t=i.defer(),n=t.bond,r=[],a=e.length,o=0;return e.forEach(function(e,u){e.then(function(){n.state===C&&(r[u]=T.call(arguments),o++,o===a&&t.resolve.apply(null,q.apply([],r)))},t.reject)}),n},i.race=function(e){var t=i.defer();return e.forEach(function(e){e.then(t.resolve,t.reject)}),t.bond},f.prototype={toString:function(){var e=this,t="[demand] "+e.message+" "+e.module;if(e.stack)for(;e=e.stack;)t+="\n    > "+e.message+" "+e.module;return t}},p.prototype={matches:function(e){return this.regexPattern.test(e)},remove:function(e){return e.replace(this.regexUrl,"")},process:function(e){var t=this;return e.replace(t.regexPattern,t.url)}},d.prototype={length:0,add:function(e){var t=this,n=t.queue;n.push(e),t.length++,1===n.length&&t.next()},next:function(){var e,t=this,n=t.current,r=t.queue;n&&(t.current=null,r.shift(),t.length--),r.length&&(n=t.current=t.queue[0],e=X[n.handler],!n.cached&&e.modify&&(n.source=e.modify(n.url,n.source)),e.resolve(n.path,n.source))}},h.prototype={store:function(){var e=this;w.set(e.path,e.source,e.url)},retrieve:function(){var e=this,t=w.get(e.path,e.url),n=e.cached=!!t;return n&&(e.source=t.source),n}},b={resolve:function(e,t){var n=j.createElement("script");n.type="application/javascript",n.defer=n.async=!0,n.text=t,n.setAttribute("demand-path",e),k.appendChild(n)}},x={resolve:function(e,t){var r=j.createElement("style"),a=r.styleSheet;r.type="text/css",r.media="only x",a&&(a.cssText=t)||(r.innerHTML=t),r.setAttribute("demand-path",e),k.appendChild(r),S(function(){n(function(){return r})})},modify:function(e,t){for(var n,r=y.url(e+"/..").href;n=N.exec(t);)t=t.replace(n[0],"url("+y.url(r+n[1]).pathname+")");return t}},g=new d,a("application/javascript",".js",b),a("text/css",".css",x),r(M)&&U&&r(U),t.configure=r,t.addHandler=a,t.clear=w.clear,e.demand=t,e.provide=n,n("/demand",function(){return t}),n("/provide",function(){return n}),n("/bond",function(){return i}),O&&t(O)}(this);