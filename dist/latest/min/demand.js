/*! Qoopido.js 4.0.0, 2015-09-02 | https://github.com/dlueth/qoopido.js | (c) 2015 Dirk Lueth */
!function(e){"use strict";function t(){var e=this||{},t=i(e,m)?e:null,n=M.call(arguments);return n.forEach(function(e,n){var r=E.path(e,t),a=r.handler,u=r.path,o=_[a]||(_[a]={});this[n]=o[u]||(o[u]=new d(e,t).pledge)},n),s.all(n)}function n(){var e,t,n=arguments[0]&&"string"==typeof arguments[0]&&arguments[0]||null,r=!n&&arguments[0]||arguments[1];if(!n&&b.current&&(t=b.current,n=t.handler+"!"+t.path),!n)throw new p("unspecified anonymous provide");return k(function(){var a,u,o,l=E.path(n),c=_[l.handler];if(!t&&c[l.path])throw new p("duplicate found for module",n);a=new m(n,r,e||[]),u=_[a.handler][a.path]=a.pledge,t&&(!t.cached&&t.store(),o=t.defered,u.then(function(){o.resolve.apply(null,arguments)},function(){o.reject(new p("unable to resolve module",n,arguments))}),b.length>0&&b.next())}),{when:function(){e=M.call(arguments)}}}function r(e){var t,n=e.timeout,r=e.version,a=e.lifetime,u=e.base,o=e.pattern,l=e.tests;if(typeof e.cache!==H&&(g=!!e.cache),n&&(y=1e3*Math.min(Math.max(parseInt(n,10),2),10)),r&&(w=r),a&&(x=1e3*Math.max(parseInt(a,10),0)),u&&(v=ee.base=new f(U,E.url(u).href)),o)for(t in o)"base"!==t&&(ee[t]=new f(t,o[t]));if(l)for(t in l)te[t]=l[t];return!0}function a(e,t,n){ne[e]||(ne[e]={suffix:t,resolve:n.resolve,modify:n.modify},_[e]={})}function u(e){var t=i(e,p)?"error":"warn";typeof console!==H&&console[t](e.toString())}function o(e){return e.replace(Q,"\\$&")}function l(e){return B.test(e)}function c(e){return e.replace(z,"")}function i(e,t){return e instanceof t}function s(e){function t(){r(C,arguments)}function n(){r(L,arguments)}function r(e,t){a.state===$&&(a.state=e,a.value=t,u[e].forEach(function(e){e.apply(null,a.value)}))}var a=this,u={resolved:[],rejected:[]};a.then=function(e,t){var n=this;if(n.state===$)e&&u[C].push(e),t&&u[L].push(t);else switch(n.state){case C:e.apply(null,n.value);break;case L:t.apply(null,n.value)}},e(t,n)}function p(e,t,n){var r=this;return r.message=e,r.module=t,n&&(r.stack=M.call(n)),r}function f(e,t){var n=this;n.url=E.url(t).href,n.regexPattern=i(e,RegExp)?e:new RegExp("^"+o(e)),n.regexUrl=new RegExp("^"+o(t))}function h(){var e=this;e.queue=[],e.current=null}function d(e,t){var n,r=this,a=s.defer(),o=new XMLHttpRequest;return E.path.call(r,e,t),r.defered=a,r.pledge=a.pledge,n=ne[r.handler],parent||r.pledge.then(null,u),n?(r.retrieve(),r.cached?b.add(r):(o.onreadystatechange=function(){4===o.readyState&&(200===o.status||0===o.status&&o.responseText?(r.source=o.responseText,b.add(r)):a.reject(new p("unable to load module",r.path)))},o.open("GET",r.url+n.suffix,!0),o.send(),k(function(){o.readyState<4&&o.abort()},y))):a.reject(new p('no handler "'+r.handler+'" for',r.path)),r}function m(e,n,r){var a=this,o=s.defer();return E.path.call(a,e),a.pledge=o.pledge,a.pledge.then(null,function(){u(new p("unable to resolve module",a.path,arguments))}),r.length>0?t.apply(a,r).then(function(){o.resolve(n.apply(null,arguments))},function(){o.reject(new p("unable to resolve dependencies for",a.path,arguments))}):o.resolve(n()),a}var v,g,y,w,x,b,E,j,I,S,T=e.document,k=e.setTimeout,q=e.setInterval,A=e.clearInterval,M=Array.prototype.slice,R=Array.prototype.concat,N=T.getElementsByTagName("head")[0],O=T.createElement("a"),D="[demand]",H="undefined",J="[state]",P="[value]",$="pending",C="resolved",L="rejected",U=/^/,B=/^\//i,G=/^([-\w]+\/[-\w]+)!/,Q=/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,X=/url\(\s*(?:"|'|)(?!data:|http:|https:|\/)(.+?)(?:"|'|)\)/g,z=/^http(s?):/,F=/^\[demand\]\[(.+?)\]\[state\]$/,K=e.localStorage,V=K&&typeof K.remainingSpace!==H,W={cache:!0,version:"1.0.0",lifetime:0,timeout:5,base:"/"},Y=e.demand.main,Z=e.demand.settings,_={},ee={},te={},ne={};E={url:function(e){return O.href=e,O},path:function(e,t){var n,r,a=this,u=e.match(G)||"application/javascript",s=i(a,d);"string"!=typeof u&&(e=e.replace(new RegExp("^"+o(u[0])),""),u=u[1]),e=l(e)?v.remove(E.url(v.url+e).href):E.url((t&&t.path+"/../"||"/")+e).pathname;for(n in ee)ee[n].matches(e)&&(r=ee[n]);return s||i(a,m)?(a.handler=u,a.path=e,s&&(a.url=c(E.url(r.process(e)).href)),void 0):{handler:u,path:e}}},j={get:function(e,t){var n,r;if(K&&g){if(n=D+"["+e+"]",r=JSON.parse(K.getItem(n+J)),r&&r.version===w&&r.url===t&&(0===r.expires||r.expires>(new Date).getTime()))return K.getItem(n+P);j.clear(e)}},set:function(e,t,n){var r,a;if(K&&g){r=D+"["+e+"]";try{if(a=V?K.remainingSpace:null,K.setItem(r+P,t),K.setItem(r+J,JSON.stringify({version:w,expires:x>0?(new Date).getTime()+x:0,url:n})),null!==a&&K.remainingSpace===a)throw"QuotaExceedError"}catch(o){u("unable to cache module "+e)}}},clear:function(e){var t,n,r,a;if(K&&g)switch(typeof e){case"string":t=D+"["+e+"]",K.removeItem(t+J),K.removeItem(t+P);break;case"boolean":for(n in K)r=n.match(F),r&&(a=JSON.parse(K.getItem(D+"["+r[1]+"]"+J)),a&&a.expires>0&&a.expires<=(new Date).getTime()&&j.clear(r[1]));break;case H:for(n in K)0===n.indexOf(D)&&K.removeItem(n)}}},s.prototype={constructor:s,state:$,value:null,listener:null},s.defer=function(){var e={};return e.pledge=new s(function(t,n){e.resolve=t,e.reject=n}),e},s.all=function(e){var t=s.defer(),n=t.pledge,r=[],a=[],u=e.length,o=0;return e.forEach(function(e,n){e.then(function(){r[n]=M.call(arguments),o++,o===u&&t.resolve.apply(null,R.apply([],r))},function(){a.push(M.call(arguments)),a.length+o===u&&t.reject.apply(null,R.apply([],a))})}),n},s.race=function(e){var t=s.defer();return e.forEach(function(e){e.then(t.resolve,t.reject)}),t.pledge},p.prototype={toString:function(){var e=this,t=D+" "+e.message+" "+e.module;return e.stack&&(t=p.traverse(e.stack,t,1)),t}},p.traverse=function(e,t,n){var r=new Array(n+1).join(" ");return e.forEach(function(e){t+="\n"+r+"> "+e.message+" "+e.module,e.stack&&(t=p.traverse(e.stack,t,n+1))}),t},f.prototype={matches:function(e){return this.regexPattern.test(e)},remove:function(e){return e.replace(this.regexUrl,"")},process:function(e){var t=this;return e.replace(t.regexPattern,t.url)}},h.prototype={length:0,add:function(e){var t=this,n=t.queue;n.push(e),t.length++,1===n.length&&t.next()},next:function(){var e,t,r,a,u,o=this,l=o.current,c=o.queue;l&&(o.current=null,c.shift(),o.length--),c.length&&(l=o.current=o.queue[0],e=l.defered,t=l.path,r=ne[l.handler],!l.cached&&r.modify&&(l.source=r.modify(l.url,l.source)),r.resolve(t,l.source),(a=te[t])&&(u=q(function(){var e=a();e&&n(function(){return e})&&A(u)},100)),k(function(){e.reject(new p("timeout resolving module",t))},y/5))}},d.prototype={store:function(){var e=this;j.set(e.path,e.source,e.url)},retrieve:function(){var e=this,t=j.get(e.path,e.url),n=e.cached=!!t;n&&(e.source=t)}},I={resolve:function(e,t){var n=T.createElement("script");n.type="application/javascript",n.defer=n.async=!0,n.text=t,n.setAttribute("demand-path",e),N.appendChild(n)}},S={resolve:function(e,t){var r=T.createElement("style"),a=r.styleSheet;r.type="text/css",r.media="only x",a&&(a.cssText=t)||(r.innerHTML=t),r.setAttribute("demand-path",e),N.appendChild(r),k(function(){n(function(){return r})})},modify:function(e,t){for(var n,r=E.url(e+"/..").href;n=X.exec(t);)t=t.replace(n[0],"url("+E.url(r+n[1]).pathname+")");return t}},b=new h,j.clear(!0),a("application/javascript",".js",I),a("text/css",".css",S),r(W)&&Z&&r(Z),t.configure=r,t.addHandler=a,t.clear=j.clear,e.demand=t,e.provide=n,n("/demand",function(){return t}),n("/provide",function(){return n}),n("/pledge",function(){return s}),Y&&t(Y)}(this);